<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada Chommany School Attendance</title>
    
    <!-- Dynamic Favicons (Updated by JS) -->
    <link rel="icon" type="image/png" id="favicon">
    <link rel="apple-touch-icon" id="appleTouchIcon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans Lao', sans-serif; }
        .lao-text { font-family: 'Noto Sans Lao', sans-serif; }
        
        input:read-only, textarea:read-only {
            color: #059669;
            font-weight: bold;
            background-color: #f0fdf4;
            cursor: not-allowed;
            border-color: #86efac;
        }

        /* Logo Upload Hover Effect */
        .logo-container:hover .upload-overlay { opacity: 1; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; margin: 0; padding: 0; }
            .print-container { box-shadow: none !important; border: none !important; width: 100% !important; max-width: none !important; }
            input { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-slate-800 flex flex-col transition-all duration-300">

    <!-- Navbar -->
    <nav class="bg-emerald-700 text-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <!-- Logo Upload Area -->
                    <div class="relative logo-container cursor-pointer group" onclick="document.getElementById('logoInput').click()">
                        <div class="bg-white text-emerald-700 p-1 rounded-lg font-bold text-xl h-10 w-10 flex items-center justify-center overflow-hidden border-2 border-transparent group-hover:border-white transition-all">
                            <img id="appLogoDisplay" src="" alt="NSS" class="w-full h-full object-contain hidden">
                            <span id="defaultLogoText">NSS</span>
                        </div>
                        <!-- Upload Overlay -->
                        <div class="upload-overlay absolute inset-0 bg-black/50 rounded-lg opacity-0 transition-opacity flex items-center justify-center text-[8px] text-white font-bold pointer-events-none">
                            UPLOAD
                        </div>
                        <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="window.handleLogoUpload(this)">
                    </div>

                    <div>
                        <h1 class="font-bold text-lg leading-tight">Neerada Chommany School</h1>
                        <p class="text-xs text-emerald-100 opacity-90 lao-text">‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô ‡∫ô‡∫µ‡∫£‡∫∞‡∫î‡∫≤ ‡∫à‡∫≠‡∫°‡∫°‡∫∞‡∫ô‡∫µ</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="connectionStatus" class="text-xs bg-yellow-600 px-2 py-1 rounded-full flex items-center gap-1 transition-colors">
                        <div class="w-2 h-2 bg-yellow-200 rounded-full animate-pulse"></div>
                        Connecting...
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <!-- w-full for mobile, max-w-7xl for laptop/desktop optimization -->
    <main class="w-full max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 py-4 sm:py-8 flex-grow">
        
        <!-- Controls -->
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 border border-gray-200 no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <!-- Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date (Mon-Fri) / ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</label>
                    <input type="date" id="dateSelector" class="w-full border-gray-300 border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                
                <!-- Department Tabs -->
                <div class="lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department / ‡∫û‡∫≤‡∫Å‡∫ß‡∫¥‡∫ä‡∫≤</label>
                    <div class="flex flex-wrap gap-2 sm:gap-0 bg-gray-100 p-1 rounded-lg">
                        <!-- Kindergarten (First) -->
                        <button onclick="window.switchTab('kindergarten')" id="tab-kindergarten" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all lao-text">Kindergarten<br><span class="text-[10px] sm:text-xs">‡∫≠‡∫∞‡∫ô‡∫∏‡∫ö‡∫≤‡∫ô</span></button>
                        <!-- Primary (Second) -->
                        <button onclick="window.switchTab('primary')" id="tab-primary" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all lao-text">Primary<br><span class="text-[10px] sm:text-xs">‡∫õ‡∫∞‡∫ñ‡∫ª‡∫°</span></button>
                        <!-- Secondary (Third) -->
                        <button onclick="window.switchTab('secondary')" id="tab-secondary" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all bg-white shadow text-emerald-700 lao-text">Secondary<br><span class="text-[10px] sm:text-xs">‡∫°‡∫±‡∫î‡∫ó‡∫∞‡∫ç‡∫ª‡∫°</span></button>
                    </div>
                </div>

                <!-- Primary Actions -->
                <div id="primaryActions" class="md:col-span-2 lg:col-span-4 flex flex-col sm:flex-row gap-2 mt-2">
                    <!-- Manual Save Button -->
                    <button onclick="window.saveCurrentData(true)" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm flex items-center justify-center gap-2 opacity-80 hover:opacity-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586l-1.293-1.293z" /><path d="M5 18a2 2 0 002 2h6a2 2 0 002-2V8l-3.5-3.5H7a2 2 0 00-2 2v10z" /></svg>
                        Save Data
                    </button>
                    <button onclick="window.print()" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition shadow-sm">Print PDF</button>
                    <button onclick="window.captureImage()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm flex items-center justify-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                          Capture Image
                    </button>
                    <button onclick="window.copyTextSummary()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition shadow-sm border border-gray-300">Copy Text</button>
                </div>
            </div>
        </div>

        <!-- ================= TABLE VIEW (NOW SECONDARY) ================= -->
        <div id="tableViewWrapper">
            <!-- Removed overflow-hidden here to help mobile scrolling/capturing of long lists -->
            <div id="reportCard" class="print-container bg-white rounded-none md:rounded-xl shadow-lg border border-gray-200 print-border relative z-0">
                <div class="bg-gray-50 border-b border-gray-200 p-4 sm:p-6 text-center relative">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 lao-text">‡∫™‡∫∞‡∫ñ‡∫¥‡∫ï‡∫¥‡∫Å‡∫≤‡∫ô‡∫°‡∫≤‡∫Ç‡∫≤‡∫î‡∫Ç‡∫≠‡∫á‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô ‡∫°‡∫±‡∫î‡∫ó‡∫∞‡∫ç‡∫ª‡∫° ‡∫™‡∫ª‡∫Å <span id="schoolYear">2025-2026</span></h2>
                    <p class="text-gray-600 mt-1 lao-text">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ <span id="displayDate" class="font-semibold">...</span></p>
                </div>
                <div class="overflow-x-auto">
                    <!-- Added min-w-[800px] to force horizontal scrolling on mobile -->
                    <table class="w-full min-w-[800px] text-sm text-left">
                        <thead>
                            <tr class="bg-emerald-100 text-emerald-900 border-b border-emerald-200 text-center">
                                <th class="p-2 w-10 border-r border-emerald-200 text-xs">No.<br><span class="text-[10px] lao-text">‡∫•/‡∫î</span></th>
                                <th class="p-2 w-32 border-r border-emerald-200 text-xs">Class/Name<br><span class="text-[10px] lao-text">‡∫´‡ªâ‡∫≠‡∫á/‡∫ä‡∫∑‡ªà</span></th>
                                <th class="p-2 w-20 border-r border-emerald-200 bg-emerald-50 text-xs">Total<br><span class="text-[10px] lao-text">‡ªÄ‡∫î‡∫µ‡∫°</span></th>
                                <th class="p-2 w-20 border-r border-emerald-200 text-xs">Pres<br><span class="text-[10px] lao-text">‡∫°‡∫≤</span></th>
                                <th class="p-2 w-20 border-r border-emerald-200 text-red-700 bg-red-50 text-xs">Abs<br><span class="text-[10px] lao-text">‡∫Ç‡∫≤‡∫î</span></th>
                                <th class="p-2 text-left text-xs">Rmks<br><span class="text-[10px] lao-text">‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î</span></th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="divide-y divide-gray-200"></tbody>
                        
                        <!-- Student Total Row (Injected here) -->
                        <tbody id="studentTotalBody" class="bg-emerald-50/50 border-t-2 border-emerald-100"></tbody>

                        <thead class="bg-gray-100 border-t-4 border-gray-200"><tr class="text-left"><th colspan="6" class="p-2 pl-3 text-xs font-bold text-gray-600 uppercase">Teachers / <span class="lao-text font-normal">‡∫Ñ‡∫π‡∫≠‡∫≤‡∫à‡∫≤‡∫ô</span></th></tr></thead>
                        <tbody id="teacherTableBody" class="divide-y divide-gray-200 bg-gray-50/50"></tbody>

                        <!-- Teacher Total Row (Injected here) -->
                        <tbody id="teacherTotalBody" class="bg-blue-50/50 border-t-2 border-blue-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ================= FORM VIEW WRAPPER (FOR PRIMARY & KINDERGARTEN) ================= -->
        <div id="formViewWrapper" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- INPUT FORM -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg text-sm">Input</span>
                        <span id="formTitleLao" class="lao-text">‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô ‡∫õ‡∫∞‡∫ñ‡∫ª‡∫°</span>
                    </h3>
                    
                    <div class="space-y-6">
                        <!-- Student Section -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <label class="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Students / <span class="lao-text font-normal">‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô</span></label>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1 font-semibold">Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</label>
                                    <input type="number" id="form_stu_total" placeholder="0" class="w-full border border-gray-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
                                </div>
                                <div>
                                    <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / ‡∫Ç‡∫≤‡∫î</label>
                                    <input type="number" id="form_stu_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
                                </div>
                                <div>
                                    <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / ‡∫°‡∫≤</label>
                                    <input type="number" id="form_stu_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Teacher Section -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <label class="block text-sm font-bold text-blue-800 mb-3 uppercase tracking-wide">Teachers / <span class="lao-text font-normal">‡∫Ñ‡∫π‡∫≠‡∫≤‡∫à‡∫≤‡∫ô</span></label>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-blue-600 mb-1 font-semibold">Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</label>
                                    <input type="number" id="form_tea_total" placeholder="0" class="w-full border border-blue-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
                                </div>
                                <div>
                                    <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / ‡∫Ç‡∫≤‡∫î</label>
                                    <input type="number" id="form_tea_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
                                </div>
                                <div>
                                    <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / ‡∫°‡∫≤</label>
                                    <input type="number" id="form_tea_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Remarks Section -->
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                            <label class="block text-sm font-bold text-yellow-800 mb-2 uppercase tracking-wide">Remarks / <span class="lao-text font-normal">‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î</span></label>
                            <textarea id="form_remarks" rows="2" class="w-full border border-yellow-300 bg-white rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none transition lao-text" placeholder="Write who is absent and why... (‡∫Ç‡∫Ω‡∫ô‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î)" oninput="window.autoSave()"></textarea>
                        </div>
                    </div>
                </div>

                <!-- PREVIEW & COPY -->
                <div class="flex flex-col h-full">
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 flex-1 flex flex-col">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="bg-green-100 text-green-700 p-1.5 rounded-lg text-sm">Preview</span>
                            <span class="lao-text">‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫á‡∫≤‡∫ô</span>
                        </h3>
                        
                        <!-- The Text Box -->
                        <div id="formReportText" class="flex-1 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 lao-text text-base leading-relaxed text-gray-800 font-medium whitespace-pre-wrap font-sans">
                            <!-- JS fills this -->
                        </div>

                        <!-- Copy Button -->
                        <button onclick="window.copyFormText()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2 text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                            Copy for WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">Changes saved</div>
        <div id="loadingOverlay" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-4 rounded-xl flex items-center gap-3"><div class="w-5 h-5 border-2 border-emerald-600 border-t-transparent rounded-full animate-spin"></div><span>Generating...</span></div></div>

    </main>
    
    <!-- Footer with Dynamic Copyright -->
    <footer class="text-center py-4 text-gray-500 text-sm no-print mt-auto border-t border-gray-200">
        &copy; <span id="copyrightYear"></span> ‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô ‡∫ô‡∫µ‡∫£‡∫∞‡∫î‡∫≤ ‡∫à‡∫≠‡∫°‡∫°‡∫∞‡∫ô‡∫µ (Neerada Chommany School). All rights reserved.
    </footer>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        // Import Firebase (Modular - CDN Version)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =================================================================
        // üî¥ FIREBASE CONFIG üî¥
        // =================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyDNpzkpMyI16hVre0h2EHUYrtx3Evk9asE",
  authDomain: "neerada-attendance.firebaseapp.com",
  projectId: "neerada-attendance",
  storageBucket: "neerada-attendance.firebasestorage.app",
  messagingSenderId: "609157341401",
  appId: "1:609157341401:web:bef8bcc6fbd9d7ceb01ec8"
};
        // =================================================================

        // --- GLOBAL APP ID (For path structure) ---
        const APP_ID = 'neerada-chommany-app'; 

        // --- STATE ---
        let db = null;
        let auth = null;
        let user = null;
        let currentDept = 'secondary'; // Default is the Table View (now Secondary)
        let currentDate = '';
        let tableData = [];
        let teacherData = [];
        
        // Stats containers for Form Views
        let primaryStats = { stuTotal: 0, stuAbsent: 0, teaTotal: 0, teaAbsent: 0, remarks: '' };
        let kindergartenStats = { stuTotal: 0, stuAbsent: 0, teaTotal: 0, teaAbsent: 0, remarks: '' };
        
        // Stats for Table View (Secondary)
        let liveStats = { students: { total: 0, present: 0, absent: 0 }, teachers: { total: 0, present: 0, absent: 0 } };
        let saveTimeout; // For debounce

        // --- CONSTANTS ---
        const CLASS_STRUCTURE = {
            'secondary': [ // Updated Secondary List
                { id: 'm1ac', name: '‡∫°1AC', total: 27 }, { id: 'm1bc', name: '‡∫°1BC', total: 24 },
                { id: 'm2ac', name: '‡∫°2AC', total: 29 }, { id: 'm2bc', name: '‡∫°2BC', total: 31 },
                { id: 'm3ac', name: '‡∫°3AC', total: 29 }, { id: 'm3bc', name: '‡∫°3BC', total: 30 },
                { id: 'm4ac', name: '‡∫°4AC', total: 32 }, { id: 'm4bc', name: '‡∫°4BC', total: 29 },
                { id: 'm5ac', name: '‡∫°5AC', total: 31 }, { id: 'm5bc', name: '‡∫°5BC', total: 32 },
                { id: 'm6ac', name: '‡∫°6AC', total: 25 }, { id: 'm6bc', name: '‡∫°6BC', total: 29 },
                { id: 'm7ac', name: '‡∫°7AC', total: 22 }, { id: 'm7bc', name: '‡∫°7BC', total: 20 },
            ]
        };

        const TEACHER_DEFAULTS = [
            { id: 't_lao', name: 'Lao Teachers (‡∫Ñ‡∫π‡∫•‡∫≤‡∫ß)', total: 0, absent: 0, remarks: '' },
            { id: 't_eng', name: 'English Teachers (‡∫Ñ‡∫π‡∫û‡∫≤‡∫™‡∫≤‡∫≠‡∫±‡∫á‡∫Å‡∫¥‡∫î)', total: 0, absent: 0, remarks: '' }
        ];

        // --- INIT FIREBASE ---
        async function initFirebase() {
            try {
                if (!firebaseConfig.apiKey) {
                    console.warn("Firebase Config missing! Using Offline Mode.");
                    document.getElementById('connectionStatus').innerHTML = '<span class="text-gray-400">Offline Mode</span>';
                    loadDataForView(); // Load empty/default data
                    return;
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        document.getElementById('connectionStatus').innerHTML = `<div class="w-2 h-2 bg-green-400 rounded-full"></div> Connected`;
                        loadDataForView();
                        loadSettings();
                    } else {
                         signInAnonymously(auth).catch(e => console.error(e));
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('connectionStatus').innerHTML = '<span class="text-red-200">Error</span>';
                loadDataForView();
            }
        }

        // --- DB OPERATIONS ---
        async function loadRecord(date) {
            if (!db || !user) return null;
            try {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', date);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (e) {
                console.error("Load Error:", e);
                return null;
            }
        }

        async function saveRecord(date, dept, data, teachersOrSecStats) {
            if (!db || !user) return;
            try {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', date);
                const docSnap = await getDoc(docRef);
                let record = docSnap.exists() ? docSnap.data() : { date: date, departments: {}, teachers: [] };

                if (dept === 'secondary') {
                    // Secondary uses table data structure now
                    record.departments['secondary'] = data;
                    record.teachers = teachersOrSecStats;
                } else {
                    // Primary and Kindergarten use simple stats objects
                    record.departments[dept + '_stats'] = data;
                }
                await setDoc(docRef, record);
                return true;
            } catch (e) { console.error("Save Error:", e); throw e; }
        }

        // --- DATA LOADING LOGIC ---
        async function loadDataForView() {
            // Default/Offline Loading Logic
            let data = null;
            if(db && user) {
                data = await loadRecord(currentDate);
            }
            
            if (currentDept === 'secondary') {
                // Load Table Data (Now called Secondary)
                if (data && data.departments && data.departments['secondary']) {
                    tableData = data.departments['secondary'];
                    teacherData = data.teachers || JSON.parse(JSON.stringify(TEACHER_DEFAULTS));
                } else {
                    // Initialize with defaults
                    tableData = JSON.parse(JSON.stringify(CLASS_STRUCTURE['secondary']));
                    teacherData = JSON.parse(JSON.stringify(TEACHER_DEFAULTS));
                }
                
                // Sanitize Teacher Names
                if (teacherData && teacherData.length > 0) {
                     teacherData.forEach(t => {
                         if (t.name.includes('<br>')) {
                             t.name = t.name.replace(/<[^>]*>/g, ' ').replace('Lao Teachers', 'Lao Teachers (‡∫Ñ‡∫π‡∫•‡∫≤‡∫ß)').replace('English Teachers', 'English Teachers (‡∫Ñ‡∫π‡∫û‡∫≤‡∫™‡∫≤‡∫≠‡∫±‡∫á‡∫Å‡∫¥‡∫î)').trim();
                         }
                     });
                }
                renderTable();

            } else {
                // Load Form Data (Primary or Kindergarten)
                let statsKey = currentDept + '_stats';
                let statsObj = { stuTotal: 0, stuAbsent: 0, teaTotal: 0, teaAbsent: 0, remarks: '' };

                if (data && data.departments && data.departments[statsKey]) {
                    statsObj = data.departments[statsKey];
                }

                // Update Local State
                if (currentDept === 'primary') primaryStats = statsObj;
                else kindergartenStats = statsObj;

                // Populate Form
                document.getElementById('form_stu_total').value = statsObj.stuTotal || '';
                document.getElementById('form_stu_absent').value = statsObj.stuAbsent || '';
                document.getElementById('form_tea_total').value = statsObj.teaTotal || '';
                document.getElementById('form_tea_absent').value = statsObj.teaAbsent || '';
                document.getElementById('form_remarks').value = statsObj.remarks || '';
                
                updateFormCalc();
            }
        }


        // --- LOGO HANDLING (COMPRESSED) ---
        window.handleLogoUpload = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024; 
                        const MAX_HEIGHT = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const base64 = canvas.toDataURL('image/png', 0.85); 
                        
                        updateLogoUI(base64);
                        
                        if(db && user) {
                            try {
                                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
                                await setDoc(docRef, { logoUrl: base64 }, { merge: true });
                                showToast("Logo Saved & Updated!");
                            } catch(err) { console.error(err); showToast("Error saving logo (File too large for DB)"); }
                        }
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        async function loadSettings() {
            if (!db || !user) return;
            try {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().logoUrl) {
                    updateLogoUI(docSnap.data().logoUrl);
                }
            } catch (e) { console.error("Settings Load Error", e); }
        }

        function updateLogoUI(url) {
            document.getElementById('appLogoDisplay').src = url;
            document.getElementById('appLogoDisplay').classList.remove('hidden');
            document.getElementById('defaultLogoText').classList.add('hidden');
            document.getElementById('favicon').href = url;
            document.getElementById('appleTouchIcon').href = url;
        }

        // --- APP LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            const yearSpan = document.getElementById('copyrightYear');
            const schoolYearSpan = document.getElementById('schoolYear');
            const currentYear = new Date().getFullYear();
            yearSpan.textContent = currentYear;
            const month = new Date().getMonth();
            const sy = month >= 7 ? `${currentYear}-${currentYear+1}` : `${currentYear-1}-${currentYear}`;
            schoolYearSpan.textContent = sy;

            const dateSelector = document.getElementById('dateSelector');
            let d = new Date();
            if (d.getDay() === 0) d.setDate(d.getDate() + 1);
            if (d.getDay() === 6) d.setDate(d.getDate() + 2);
            currentDate = d.toISOString().split('T')[0];
            dateSelector.value = currentDate;
            document.getElementById('displayDate').textContent = formatDate(currentDate);

            dateSelector.addEventListener('input', (e) => {
                const val = e.target.value;
                if(!val) return;
                const day = new Date(val).getDay();
                if (day === 0 || day === 6) { alert("Please select a weekday (Monday - Friday)."); e.target.value = currentDate; return; }
                currentDate = val;
                document.getElementById('displayDate').textContent = formatDate(currentDate);
                loadDataForView();
            });

            initFirebase();
        });

        // --- AUTO SAVE ---
        window.autoSave = function() {
            if(currentDept === 'secondary') renderTable();
            else window.updateFormCalc();

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await window.saveCurrentData(false); 
            }, 1000);
        }

        window.saveCurrentData = async function(isManual = true) {
            try {
                if (currentDept === 'secondary') {
                    await saveRecord(currentDate, 'secondary', tableData, teacherData);
                } else if (currentDept === 'primary') {
                    await saveRecord(currentDate, 'primary', primaryStats, null);
                } else {
                    await saveRecord(currentDate, 'kindergarten', kindergartenStats, null);
                }
                showToast(isManual ? "Data saved successfully!" : "Changes saved");
            } catch (e) { console.error(e); if(isManual) showToast("Error saving data (Check Config)."); }
        }

        window.updateRow = function(type, index, field, value) {
            const arr = type === 'student' ? tableData : teacherData;
            
            if (field === 'remarks' || field === 'name') {
                arr[index][field] = value;
            } else {
                arr[index][field] = parseInt(value) || 0;
            }
            
            renderTable();
            window.autoSave(); 
        }

        window.switchTab = function(dept) {
            currentDept = dept;
            const secTab = document.getElementById('tab-secondary');
            const primTab = document.getElementById('tab-primary');
            const kinTab = document.getElementById('tab-kindergarten');
            
            const tableView = document.getElementById('tableViewWrapper');
            const formView = document.getElementById('formViewWrapper');
            const primaryActions = document.getElementById('primaryActions');

            // Reset Styles
            const activeStyle = "flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all bg-white shadow text-emerald-700 lao-text";
            const inactiveStyle = "flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all hover:bg-gray-200 lao-text";
            
            secTab.className = inactiveStyle;
            primTab.className = inactiveStyle;
            kinTab.className = inactiveStyle;

            if (dept === 'secondary') {
                secTab.className = activeStyle;
                tableView.classList.remove('hidden');
                formView.classList.add('hidden');
                primaryActions.classList.remove('hidden'); // Show table actions (Save/Print)
            } else {
                if (dept === 'primary') primTab.className = activeStyle;
                else kinTab.className = activeStyle;
                
                tableView.classList.add('hidden');
                formView.classList.remove('hidden');
                primaryActions.classList.add('hidden'); // Hide table actions, form has copy button
                
                // Update Form Title
                const formTitle = document.getElementById('formTitleLao');
                if(dept === 'primary') formTitle.innerText = "‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô ‡∫õ‡∫∞‡∫ñ‡∫ª‡∫° (Primary)";
                else formTitle.innerText = "‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô ‡∫≠‡∫∞‡∫ô‡∫∏‡∫ö‡∫≤‡∫ô (Kindergarten)";
            }
            loadDataForView();
        }

        window.updateFormCalc = function() {
            const stuTotal = parseInt(document.getElementById('form_stu_total').value) || 0;
            const stuAbsent = parseInt(document.getElementById('form_stu_absent').value) || 0;
            const teaTotal = parseInt(document.getElementById('form_tea_total').value) || 0;
            const teaAbsent = parseInt(document.getElementById('form_tea_absent').value) || 0;
            const remarks = document.getElementById('form_remarks').value || '';

            const stuPresent = Math.max(0, stuTotal - stuAbsent);
            const teaPresent = Math.max(0, teaTotal - teaAbsent);
            const grandTotal = stuPresent + teaPresent;

            document.getElementById('form_stu_present').value = stuPresent;
            document.getElementById('form_tea_present').value = teaPresent;

            const newStats = { stuTotal, stuAbsent, teaTotal, teaAbsent, remarks };
            
            if(currentDept === 'primary') primaryStats = newStats;
            else kindergartenStats = newStats;

            const dateStr = formatDateShort(currentDate);
            const percent = stuTotal > 0 ? ((stuPresent / stuTotal) * 100).toFixed(1) + '%' : '0%';
            
            const deptName = currentDept === 'primary' ? '‡∫õ‡∫∞‡∫ñ‡∫ª‡∫° (Primary)' : '‡∫≠‡∫∞‡∫ô‡∫∏‡∫ö‡∫≤‡∫ô (Kindergarten)';

            // PREVIEW TEXT FORMAT
            const reportHTML = `Neerada Chommany School Attendance / ‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô ‡∫ô‡∫µ‡∫£‡∫∞‡∫î‡∫≤ ‡∫à‡∫≠‡∫°‡∫°‡∫∞‡∫ô‡∫µ
üìÖ Date / ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ${dateStr} (${deptName})
------------------
üéì Students / ‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô:
üë• Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ${stuTotal}
‚úÖ Present / ‡∫°‡∫≤: ${stuPresent}
‚ùå Absent / ‡∫Ç‡∫≤‡∫î: ${stuAbsent}
üìä Rate / ‡ªÄ‡∫õ‡∫µ‡ªÄ‡∫ä‡∫±‡∫ô: ${percent}

üë©‚Äçüè´ Teachers / ‡∫Ñ‡∫π‡∫≠‡∫≤‡∫à‡∫≤‡∫ô & ‡∫Ñ‡∫π‡∫Æ‡∫±‡∫ö‡ªÄ‡∫ä‡∫µ‡∫ô:
üë• Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ${teaTotal}
‚úÖ Present / ‡∫°‡∫≤: ${teaPresent}
‚ùå Absent / ‡∫Ç‡∫≤‡∫î: ${teaAbsent}
üìù ‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î / Remarks: ${remarks || '-'}
üìä ‡∫•‡∫ß‡∫°‡∫Ñ‡∫π ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô‡∫°‡∫≤‡∫ï‡∫ª‡∫ß‡∫à‡∫¥‡∫á: ${grandTotal}`;
            document.getElementById('formReportText').innerText = reportHTML;
        }

        // Helper: Format Date
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${days[d.getDay()]} ${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
        }
        function formatDateShort(dateStr) {
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
        }

        // Helper: Render Table (Secondary)
        function renderTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            liveStats.students = { total: 0, present: 0, absent: 0 };
            liveStats.teachers = { total: 0, present: 0, absent: 0 }; 

            tableData.forEach((row, index) => {
                const total = parseInt(row.total) || 0;
                const absent = parseInt(row.absent) || 0;
                const present = Math.max(0, total - absent);
                liveStats.students.total += total; liveStats.students.present += present; liveStats.students.absent += absent;

                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tr.innerHTML = `
                    <td class="p-2 border-r border-gray-200 text-center text-gray-500 text-xs">${index + 1}</td>
                    <td class="p-0 border-r border-gray-200">
                        <input type="text" class="w-full h-full p-2 text-center font-bold text-xs bg-transparent focus:bg-emerald-50 outline-none" 
                        value="${row.name}" onchange="updateRow('student', ${index}, 'name', this.value)">
                    </td>
                    <td class="p-0 border-r border-gray-200"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-emerald-50 outline-none text-xs" value="${row.total}" onchange="updateRow('student', ${index}, 'total', this.value)"></td>
                    <td class="p-0 border-r border-gray-200"><input type="number" readonly class="w-full h-full p-2 text-center outline-none text-xs" value="${present}"></td>
                    <td class="p-0 border-r border-gray-200 bg-red-50/30"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-red-50 text-red-700 font-bold outline-none text-xs" value="${row.absent}" onchange="updateRow('student', ${index}, 'absent', this.value)"></td>
                    <td class="p-0"><input type="text" class="w-full h-full p-2 text-left bg-transparent focus:bg-yellow-50 outline-none lao-text text-[10px]" value="${row.remarks || ''}" onchange="updateRow('student', ${index}, 'remarks', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });

            // Teachers
            const teacherBody = document.getElementById('teacherTableBody');
            teacherBody.innerHTML = '';
            teacherData.forEach((row, index) => {
                const total = parseInt(row.total) || 0;
                const absent = parseInt(row.absent) || 0;
                const present = Math.max(0, total - absent);
                liveStats.teachers.total += total; liveStats.teachers.present += present; liveStats.teachers.absent += absent; 

                teacherBody.innerHTML += `
                    <tr>
                        <td class="p-2 border-r border-gray-200 text-center text-gray-400 text-xs">-</td>
                        <td class="p-0 border-r border-gray-200">
                            <input type="text" class="w-full h-full p-2 text-center font-bold text-gray-700 text-xs bg-transparent focus:bg-emerald-50 outline-none" 
                            value="${row.name}" onchange="updateRow('teacher', ${index}, 'name', this.value)">
                        </td>
                        <td class="p-0 border-r border-gray-200"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-emerald-50 outline-none text-xs" value="${row.total}" onchange="updateRow('teacher', ${index}, 'total', this.value)"></td>
                        <td class="p-0 border-r border-gray-200"><input type="number" readonly class="w-full h-full p-2 text-center outline-none text-xs" value="${present}"></td>
                        <td class="p-0 border-r border-gray-200 bg-red-50/30"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-red-50 text-red-700 font-bold outline-none text-xs" value="${row.absent}" onchange="updateRow('teacher', ${index}, 'absent', this.value)"></td>
                        <td class="p-0"><input type="text" class="w-full h-full p-2 text-left bg-transparent focus:bg-yellow-50 outline-none lao-text text-[10px]" value="${row.remarks || ''}" onchange="updateRow('teacher', ${index}, 'remarks', this.value)"></td>
                    </tr>
                `;
            });

            // Student Summary Row 
            const percentStudents = liveStats.students.total > 0 ? ((liveStats.students.present / liveStats.students.total) * 100).toFixed(1) : 0;
            document.getElementById('studentTotalBody').innerHTML = `
                <tr class="bg-emerald-100 font-bold text-gray-900">
                    <td colspan="2" class="p-2 border-r border-emerald-200 text-right pr-2 lao-text text-xs">‡∫•‡∫ß‡∫°‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô (Total Students)</td>
                    <td class="p-2 border-r border-emerald-200 text-xs text-center">${liveStats.students.total}</td>
                    <td class="p-2 border-r border-emerald-200 text-xs text-center">${liveStats.students.present}</td>
                    <td class="p-2 border-r border-emerald-200 text-red-700 text-xs text-center">${liveStats.students.absent}</td>
                    <td class="p-2 text-left text-[10px] text-gray-600"><span class="font-bold">${percentStudents}%</span> Present</td>
                </tr>
            `;

            // Teacher Summary Row
            const percentTeachers = liveStats.teachers.total > 0 ? ((liveStats.teachers.present / liveStats.teachers.total) * 100).toFixed(1) : 0;
            document.getElementById('teacherTotalBody').innerHTML = `
                <tr class="bg-blue-100 font-bold text-gray-900">
                    <td colspan="2" class="p-2 border-r border-blue-200 text-right pr-2 lao-text text-xs">‡∫•‡∫ß‡∫°‡∫Ñ‡∫π (Total Teachers)</td>
                    <td class="p-2 border-r border-blue-200 text-xs text-center">${liveStats.teachers.total}</td>
                    <td class="p-2 border-r border-blue-200 text-xs text-center">${liveStats.teachers.present}</td>
                    <td class="p-2 border-r border-blue-200 text-red-700 text-xs text-center">${liveStats.teachers.absent}</td>
                    <td class="p-2 text-left text-[10px] text-gray-600"><span class="font-bold">${percentTeachers}%</span> Present</td>
                </tr>
            `;
        }

        window.copyFormText = function() {
            const text = document.getElementById('formReportText').innerText;
            copyToClipboard(text);
        }

        window.copyTextSummary = function() {
            const dateStr = formatDateShort(currentDate);
            const percent = liveStats.students.total > 0 ? ((liveStats.students.present / liveStats.students.total) * 100).toFixed(1) + '%' : '0%';
            
            // Gather Teacher Remarks
            let teacherRemarks = [];
            teacherData.forEach(t => {
                if(t.remarks && t.remarks.trim() !== '') {
                    const shortName = t.name.replace(/<[^>]*>/g, '').split(' (')[0]; 
                    teacherRemarks.push(`${shortName}: ${t.remarks}`);
                }
            });
            const remarksStr = teacherRemarks.length > 0 ? teacherRemarks.join(', ') : '= ‡∫°‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î';

            // PREVIEW TEXT FORMAT FOR TABLE
            const text = `Neerada Chommany School Attendance / ‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô ‡∫ô‡∫µ‡∫£‡∫∞‡∫î‡∫≤ ‡∫à‡∫≠‡∫°‡∫°‡∫∞‡∫ô‡∫µ
üìÖ Date / ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ${dateStr} (‡∫°‡∫±‡∫î‡∫ó‡∫∞‡∫ç‡∫ª‡∫°)
------------------
üéì Students / ‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô:
üë• Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ${liveStats.students.total}
‚úÖ Present / ‡∫°‡∫≤: ${liveStats.students.present}
‚ùå Absent / ‡∫Ç‡∫≤‡∫î: ${liveStats.students.absent}
üìä Rate / ‡ªÄ‡∫õ‡∫µ‡ªÄ‡∫ä‡∫±‡∫ô: ${percent}

üë©‚Äçüè´ Teachers / ‡∫Ñ‡∫π‡∫≠‡∫≤‡∫à‡∫≤‡∫ô:
üë• Total / ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ${liveStats.teachers.total}
‚úÖ Present / ‡∫°‡∫≤: ${liveStats.teachers.present}
‚ùå Absent / ‡∫Ç‡∫≤‡∫î: ${liveStats.teachers.absent}
üìù ‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î / Remarks: ${remarksStr}`;
            copyToClipboard(text);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast("Copied to Clipboard!");
            } catch (err) {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("Copied to Clipboard!");
                } catch (fallbackErr) {
                    console.error('Fallback copy failed', fallbackErr);
                    showToast("Error Copying");
                }
            }
        }

        window.captureImage = function() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            const element = document.getElementById('reportCard');
            
            const ghost = element.cloneNode(true);
            const originalInputs = element.querySelectorAll('input, textarea');
            const ghostInputs = ghost.querySelectorAll('input, textarea');

            ghostInputs.forEach((ghostInput, i) => {
                const originalInput = originalInputs[i];
                const val = originalInput.value || '';
                const div = document.createElement('div');
                div.textContent = val;
                div.className = ghostInput.className;
                div.style.display = 'flex';
                div.style.alignItems = 'center'; 
                
                if (ghostInput.classList.contains('text-center')) {
                    div.style.justifyContent = 'center';
                    div.style.textAlign = 'center';
                } else if (ghostInput.classList.contains('text-right')) {
                    div.style.justifyContent = 'flex-end';
                    div.style.textAlign = 'right';
                } else {
                    div.style.justifyContent = 'flex-start';
                    div.style.textAlign = 'left';
                }
                
                if(ghostInput.parentNode) {
                    ghostInput.parentNode.replaceChild(div, ghostInput);
                }
            });

            ghost.style.position = 'absolute';
            ghost.style.left = '0'; 
            ghost.style.top = '0';
            ghost.style.width = '800px'; 
            ghost.style.minWidth = '800px';
            ghost.style.height = 'auto'; 
            ghost.style.zIndex = '-9999'; 
            ghost.style.background = 'white';
            ghost.style.overflow = 'visible'; 
            ghost.style.transform = 'none';

            const ghostTableContainer = ghost.querySelector('.overflow-x-auto');
            if(ghostTableContainer) {
                ghostTableContainer.style.overflow = 'visible';
                ghostTableContainer.style.height = 'auto';
                ghostTableContainer.style.width = '100%';
            }

            const logoSrc = document.getElementById('appLogoDisplay').src;
            if(logoSrc && !logoSrc.includes('window.location.href')) {
                const headerDiv = ghost.querySelector('.bg-gray-50');
                if(headerDiv) {
                    const img = document.createElement('img');
                    img.src = logoSrc;
                    img.className = "absolute left-6 top-6 h-16 w-16 object-contain";
                    headerDiv.appendChild(img);
                }
            }

            document.body.appendChild(ghost);

            setTimeout(() => {
                const height = ghost.scrollHeight + 50; 
                
                const options = {
                    scale: 2, 
                    backgroundColor: '#ffffff', 
                    useCORS: true,
                    width: 800, 
                    windowWidth: 800, 
                    height: height, 
                    windowHeight: height,
                    scrollY: 0, 
                    x: 0,
                    y: 0
                };

                html2canvas(ghost, options).then(canvas => {
                    document.body.removeChild(ghost); 
                    canvas.toBlob(async blob => {
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        if (!blob) { showToast("Error generating image"); return; }
                        
                        const file = new File([blob], `attendance-${currentDate}.png`, { type: 'image/png' });
                        
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try { 
                                await navigator.share({ files: [file] }); 
                                showToast("Shared successfully!"); 
                            } catch (err) {
                                const link = document.createElement('a'); 
                                link.download = `attendance-${currentDate}.png`; 
                                link.href = canvas.toDataURL(); 
                                link.click(); 
                            }
                        } else {
                            const link = document.createElement('a'); 
                            link.download = `attendance-${currentDate}.png`; 
                            link.href = canvas.toDataURL(); 
                            link.click(); 
                            showToast("Image downloaded!");
                        }
                    }, 'image/png');
                }).catch(err => {
                    console.error(err);
                    document.body.removeChild(ghost);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    showToast("Error capturing image");
                });
            }, 500);
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>