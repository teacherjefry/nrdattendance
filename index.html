<!DOCTYPE html>
<html lang="en">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Neerada Sibounhueang School Attendance</title>
ย ยย
ย ย <!-- Dynamic Favicons (Updated by JS) -->
ย ย <link rel="icon" type="image/png" id="favicon">
ย ย <link rel="apple-touch-icon" id="appleTouchIcon">

ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
ย ย <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
ย ย <style>
ย ย ย ย body { font-family: 'Inter', 'Noto Sans Lao', sans-serif; }
ย ย ย ย .lao-text { font-family: 'Noto Sans Lao', sans-serif; }
ย ย ย ยย
ย ย ย ย input:read-only, textarea:read-only {
ย ย ย ย ย ย color: #059669;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย background-color: #f0fdf4;
ย ย ย ย ย ย cursor: not-allowed;
ย ย ย ย ย ย border-color: #86efac;
ย ย ย ย }

ย ย ย ย /* Logo Upload Hover Effect */
ย ย ย ย .logo-container:hover .upload-overlay { opacity: 1; }

ย ย ย ย /* Print Styles */
ย ย ย ย @media print {
ย ย ย ย ย ย .no-print { display: none !important; }
ย ย ย ย ย ย body { background: white; -webkit-print-color-adjust: exact; margin: 0; padding: 0; }
ย ย ย ย ย ย .print-container { box-shadow: none !important; border: none !important; width: 100% !important; max-width: none !important; }
ย ย ย ย ย ย input { border: none !important; background: transparent !important; }
ย ย ย ย }
ย ย </style>
</head>
<body class="bg-gray-100 min-h-screen text-slate-800 flex flex-col transition-all duration-300">

ย ย <!-- Navbar -->
ย ย <nav class="bg-emerald-700 text-white shadow-lg no-print">
ย ย ย ย <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
ย ย ย ย ย ย <div class="flex items-center justify-between h-16">
ย ย ย ย ย ย ย ย <div class="flex items-center gap-3">
ย ย ย ย ย ย ย ย ย ย <!-- Logo Upload Area -->
ย ย ย ย ย ย ย ย ย ย <div class="relative logo-container cursor-pointer group" onclick="document.getElementById('logoInput').click()">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white text-emerald-700 p-1 rounded-lg font-bold text-xl h-10 w-10 flex items-center justify-center overflow-hidden border-2 border-transparent group-hover:border-white transition-all">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <img id="appLogoDisplay" src="" alt="NSS" class="w-full h-full object-contain hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span id="defaultLogoText">NSS</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Upload Overlay -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="upload-overlay absolute inset-0 bg-black/50 rounded-lg opacity-0 transition-opacity flex items-center justify-center text-[8px] text-white font-bold pointer-events-none">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย UPLOAD
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="window.handleLogoUpload(this)">
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <h1 class="font-bold text-lg leading-tight">Neerada School</h1>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-emerald-100 opacity-90 lao-text">เปเบฎเบเบฎเบฝเบ เบเบตเบฃเบฐเบเบฒ เบชเบตเบเบธเบเปเบฎเบทเบญเบ</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="flex items-center gap-4">
ย ย ย ย ย ย ย ย ย ย <span id="connectionStatus" class="text-xs bg-yellow-600 px-2 py-1 rounded-full flex items-center gap-1 transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="w-2 h-2 bg-yellow-200 rounded-full animate-pulse"></div>
ย ย ย ย ย ย ย ย ย ย ย ย Connecting...
ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </nav>

ย ย <!-- Main Content -->
ย ย <!-- w-full for mobile, max-w-7xl for laptop/desktop optimization -->
ย ย <main class="w-full max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 py-4 sm:py-8 flex-grow">
ย ย ย ยย
ย ย ย ย <!-- Controls -->
ย ย ย ย <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 border border-gray-200 no-print">
ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
ย ย ย ย ย ย ย ย <!-- Date -->
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Date (Mon-Fri) / เบงเบฑเบเบเบต</label>
ย ย ย ย ย ย ย ย ย ย <input type="date" id="dateSelector" class="w-full border-gray-300 border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <!-- Department Tabs -->
ย ย ย ย ย ย ย ย <div class="lg:col-span-3">
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 mb-1">Department / เบเบฒเบเบงเบดเบเบฒ</label>
ย ย ย ย ย ย ย ย ย ย <div class="flex flex-wrap gap-2 sm:gap-0 bg-gray-100 p-1 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.switchTab('kindergarten')" id="tab-kindergarten" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all hover:bg-gray-200 text-gray-700 lao-text">Kindergarten<br><span class="text-[10px] sm:text-xs">เบญเบฐเบเบธเบเบฒเบ</span></button>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.switchTab('primary')" id="tab-primary" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all bg-white shadow text-emerald-700 lao-text">Primary<br><span class="text-[10px] sm:text-xs">เบเบฐเบเบปเบก</span></button>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.switchTab('secondary')" id="tab-secondary" class="flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all hover:bg-gray-200 text-gray-700 lao-text">Secondary<br><span class="text-[10px] sm:text-xs">เบกเบฑเบเบเบฐเบเบปเบก</span></button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <!-- Primary Actions -->
ย ย ย ย ย ย ย ย <div id="primaryActions" class="md:col-span-2 lg:col-span-4 flex flex-col sm:flex-row gap-2 mt-2">
ย ย ย ย ย ย ย ย ย ย <!-- Manual Save Button -->
ย ย ย ย ย ย ย ย ย ย <button onclick="window.saveCurrentData(true)" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm flex items-center justify-center gap-2 opacity-80 hover:opacity-100">
ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586l-1.293-1.293z" /><path d="M5 18a2 2 0 002 2h6a2 2 0 002-2V8l-3.5-3.5H7a2 2 0 00-2 2v10z" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย Save Data
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="window.print()" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition shadow-sm">Print PDF</button>
ย ย ย ย ย ย ย ย ย ย <button onclick="window.captureImage()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm flex items-center justify-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย Capture Image
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="window.copyTextSummary()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition shadow-sm border border-gray-300">Copy Text</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <!-- ================= PRIMARY VIEW (TABLE) ================= -->
ย ย ย ย <div id="primaryView">
ย ย ย ย ย ย <!-- Removed overflow-hidden here to help mobile scrolling/capturing of long lists -->
ย ย ย ย ย ย <div id="reportCard" class="print-container bg-white rounded-none md:rounded-xl shadow-lg border border-gray-200 print-border relative z-0">
ย ย ย ย ย ย ย ย <div class="bg-gray-50 border-b border-gray-200 p-4 sm:p-6 text-center relative">
ย ย ย ย ย ย ย ย ย ย <!-- Logo Removed from Body as requested -->
ย ย ย ย ย ย ย ย ย ย <!-- <img id="reportLogo" src="" class="hidden absolute left-6 top-6 h-16 w-16 object-contain"> -->
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <h2 class="text-lg sm:text-xl font-bold text-gray-800 lao-text">เบชเบฐเบเบดเบเบดเบเบฒเบเบกเบฒเบเบฒเบเบเบญเบเบเบฑเบเบฎเบฝเบ เบเบฐเบเบปเบก เบชเบปเบ <span id="schoolYear">2025-2026</span></h2>
ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600 mt-1 lao-text">เบงเบฑเบเบเบต <span id="displayDate" class="font-semibold">...</span></p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="overflow-x-auto">
ย ย ย ย ย ย ย ย ย ย <!-- Added min-w-[800px] to force horizontal scrolling on mobile -->
ย ย ย ย ย ย ย ย ย ย <table class="w-full min-w-[800px] text-sm text-left">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr class="bg-emerald-100 text-emerald-900 border-b border-emerald-200 text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 w-10 border-r border-emerald-200 text-xs">No.<br><span class="text-[10px] lao-text">เบฅ/เบ</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 w-32 border-r border-emerald-200 text-xs">Class/Name<br><span class="text-[10px] lao-text">เบซเปเบญเบ/เบเบทเป</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 w-20 border-r border-emerald-200 bg-emerald-50 text-xs">Total<br><span class="text-[10px] lao-text">เปเบเบตเบก</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 w-20 border-r border-emerald-200 text-xs">Pres<br><span class="text-[10px] lao-text">เบกเบฒ</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 w-20 border-r border-emerald-200 text-red-700 bg-red-50 text-xs">Abs<br><span class="text-[10px] lao-text">เบเบฒเบ</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="p-2 text-left text-xs">Rmks<br><span class="text-[10px] lao-text">เปเบฒเบเปเบซเบ</span></th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="attendanceTableBody" class="divide-y divide-gray-200"></tbody>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Student Total Row (Injected here) -->
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="studentTotalBody" class="bg-emerald-50/50 border-t-2 border-emerald-100"></tbody>

ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-gray-100 border-t-4 border-gray-200"><tr class="text-left"><th colspan="6" class="p-2 pl-3 text-xs font-bold text-gray-600 uppercase">Teachers / <span class="lao-text font-normal">เบเบนเบญเบฒเบเบฒเบ</span></th></tr></thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="teacherTableBody" class="divide-y divide-gray-200 bg-gray-50/50"></tbody>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Teacher Total Row (Injected here) -->
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="teacherTotalBody" class="bg-blue-50/50 border-t-2 border-blue-100"></tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <!-- ================= KINDERGARTEN VIEW (FORM ONLY) ================= -->
ย ย ย ย <div id="kindergartenView" class="hidden">
ย ย ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <!-- INPUT FORM -->
ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg text-sm">Input</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="lao-text">เบเปเบญเบเบเปเปเบกเบนเบ เบญเบฐเบเบธเบเบฒเบ</span>
ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="space-y-6">
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Student Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Students / <span class="lao-text font-normal">เบเบฑเบเบฎเบฝเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-3 gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-gray-500 mb-1 font-semibold">Total / เบเบฑเบเปเบปเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_stu_total" placeholder="0" class="w-full border border-gray-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / เบเบฒเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_stu_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / เบกเบฒ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_stu_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Teacher Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-blue-800 mb-3 uppercase tracking-wide">Teachers / <span class="lao-text font-normal">เบเบนเบญเบฒเบเบฒเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-3 gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-blue-600 mb-1 font-semibold">Total / เบเบฑเบเปเบปเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_tea_total" placeholder="0" class="w-full border border-blue-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / เบเบฒเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_tea_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / เบกเบฒ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="kin_tea_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Remarks Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-yellow-800 mb-2 uppercase tracking-wide">Remarks / <span class="lao-text font-normal">เปเบฒเบเปเบซเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <textarea id="kin_remarks" rows="2" class="w-full border border-yellow-300 bg-white rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none transition lao-text" placeholder="Write who is absent and why... (เบเบฝเบเปเบฒเบเปเบซเบ)" oninput="window.autoSave()"></textarea>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <!-- PREVIEW & COPY -->
ย ย ย ย ย ย ย ย <div class="flex flex-col h-full">
ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 flex-1 flex flex-col">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="bg-green-100 text-green-700 p-1.5 rounded-lg text-sm">Preview</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="lao-text">เบเบปเบงเบขเปเบฒเบเบฅเบฒเบเบเบฒเบ เบญเบฐเบเบธเบเบฒเบ</span>
ย ย ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <!-- The Text Box -->
ย ย ย ย ย ย ย ย ย ย ย ย <div id="kindergartenReportText" class="flex-1 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 lao-text text-base leading-relaxed text-gray-800 font-medium whitespace-pre-wrap font-sans">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- JS fills this -->
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Copy Button -->
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.copyKindergartenText()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2 text-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Copy for WhatsApp
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <!-- ================= SECONDARY VIEW (FORM ONLY) ================= -->
ย ย ย ย <div id="secondaryView" class="hidden">
ย ย ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <!-- INPUT FORM -->
ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg text-sm">Input</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="lao-text">เบเปเบญเบเบเปเปเบกเบนเบ เบกเบฑเบเบเบฐเบเบปเบก</span>
ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="space-y-6">
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Student Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Students / <span class="lao-text font-normal">เบเบฑเบเบฎเบฝเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-3 gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-gray-500 mb-1 font-semibold">Total / เบเบฑเบเปเบปเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_stu_total" placeholder="0" class="w-full border border-gray-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / เบเบฒเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_stu_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / เบกเบฒ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_stu_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Teacher Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-blue-800 mb-3 uppercase tracking-wide">Teachers / <span class="lao-text font-normal">เบเบนเบญเบฒเบเบฒเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-3 gap-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-blue-600 mb-1 font-semibold">Total / เบเบฑเบเปเบปเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_tea_total" placeholder="0" class="w-full border border-blue-300 rounded-lg p-3 text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-red-500 mb-1 font-semibold">Absent / เบเบฒเบ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_tea_absent" placeholder="0" class="w-full border border-red-300 bg-red-50 rounded-lg p-3 text-lg font-bold text-red-700 focus:ring-2 focus:ring-red-500 outline-none transition" oninput="window.autoSave()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs text-emerald-600 mb-1 font-semibold">Present / เบกเบฒ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="sec_tea_present" placeholder="0" readonly class="w-full border border-emerald-300 bg-emerald-50 rounded-lg p-3 text-lg font-bold text-emerald-700 outline-none">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Remarks Section -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-bold text-yellow-800 mb-2 uppercase tracking-wide">Remarks / <span class="lao-text font-normal">เปเบฒเบเปเบซเบ</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <textarea id="sec_remarks" rows="2" class="w-full border border-yellow-300 bg-white rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none transition lao-text" placeholder="Write who is absent and why... (เบเบฝเบเปเบฒเบเปเบซเบ)" oninput="window.autoSave()"></textarea>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <!-- PREVIEW & COPY -->
ย ย ย ย ย ย ย ย <div class="flex flex-col h-full">
ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 flex-1 flex flex-col">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="bg-green-100 text-green-700 p-1.5 rounded-lg text-sm">Preview</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="lao-text">เบเบปเบงเบขเปเบฒเบเบฅเบฒเบเบเบฒเบ</span>
ย ย ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <!-- The Text Box -->
ย ย ย ย ย ย ย ย ย ย ย ย <div id="secondaryReportText" class="flex-1 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 lao-text text-base leading-relaxed text-gray-800 font-medium whitespace-pre-wrap font-sans">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- JS fills this -->
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <!-- Copy Button -->
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.copySecondaryText()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2 text-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Copy for WhatsApp
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">Changes saved</div>
ย ย ย ย <div id="loadingOverlay" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-4 rounded-xl flex items-center gap-3"><div class="w-5 h-5 border-2 border-emerald-600 border-t-transparent rounded-full animate-spin"></div><span>Generating...</span></div></div>

ย ย </main>
ย ยย
ย ย <!-- Footer with Dynamic Copyright -->
ย ย <footer class="text-center py-4 text-gray-500 text-sm no-print mt-auto border-t border-gray-200">
ย ย ย ย &copy; <span id="copyrightYear"></span> เปเบฎเบเบฎเบฝเบ เบเบตเบฃเบฐเบเบฒ (Neerada School). All rights reserved.
ย ย </footer>

ย ย <!-- FIREBASE & APP LOGIC -->
ย ย <script type="module">
ย ย ย ย // Import Firebase (Modular - CDN Version)
ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
ย ย ย ย import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
ย ย ย ย import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

ย ย ย ย // =================================================================
ย ย ย ย // ๐ด FIREBASE CONFIG ๐ด
ย ย ย ย // =================================================================
ย ย ย ย const firebaseConfig = {
ย ย ย ย ย apiKey: "AIzaSyDNpzkpMyI16hVre0h2EHUYrtx3Evk9asE",
ย ย ย ย ย authDomain: "neerada-attendance.firebaseapp.com",
ย ย ย ย ย projectId: "neerada-attendance",
ย ย ย ย ย storageBucket: "neerada-attendance.firebasestorage.app",
ย ย ย ย ย messagingSenderId: "609157341401",
ย ย ย ย ย appId: "1:609157341401:web:346129d05c4f079eb01ec8"
ย ย ย ย };
ย ย ย ย // =================================================================

ย ย ย ย // --- GLOBAL APP ID (For path structure) ---
ย ย ย ย const APP_ID = 'neerada-school-app';ย

ย ย ย ย // --- STATE ---
ย ย ย ย let db = null;
ย ย ย ย let auth = null;
ย ย ย ย let user = null;
ย ย ย ย let currentDept = 'primary';
ย ย ย ย let currentDate = '';
ย ย ย ย let tableData = [];
ย ย ย ย let teacherData = [];
ย ย ย ย let kindergartenStats = { stuTotal: 0, stuAbsent: 0, teaTotal: 0, teaAbsent: 0, remarks: '' };
ย ย ย ย let secondaryStats = { stuTotal: 0, stuAbsent: 0, teaTotal: 0, teaAbsent: 0, remarks: '' };
ย ย ย ย let liveStats = { students: { total: 0, present: 0, absent: 0 }, teachers: { total: 0, present: 0, absent: 0 } };
ย ย ย ย let saveTimeout; // For debounce

ย ย ย ย // --- CONSTANTS ---
ย ย ย ย const CLASS_STRUCTURE = {
ย ย ย ย ย ย 'primary': [
ย ย ย ย ย ย ย ย { id: 'p1a', name: 'เบ1A', total: 26 }, { id: 'p1b', name: 'เบ1B', total: 26 }, { id: 'p1c', name: 'เบ1C', total: 25 },
ย ย ย ย ย ย ย ย { id: 'p1d', name: 'เบ1D', total: 25 }, { id: 'p1e', name: 'เบ1E', total: 23 }, { id: 'p1f', name: 'เบ1F', total: 25 }, { id: 'p1g', name: 'เบ1G', total: 27 },
ย ย ย ย ย ย ย ย { id: 'p2a', name: 'เบ2A', total: 29 }, { id: 'p2b', name: 'เบ2B', total: 30 }, { id: 'p2c', name: 'เบ2C', total: 31 },
ย ย ย ย ย ย ย ย { id: 'p2d', name: 'เบ2D', total: 29 }, { id: 'p2e', name: 'เบ2E', total: 27 }, { id: 'p2f', name: 'เบ2F', total: 26 }, { id: 'p2g', name: 'เบ2G', total: 26 },
ย ย ย ย ย ย ย ย { id: 'p3a', name: 'เบ3A', total: 27 }, { id: 'p3b', name: 'เบ3B', total: 28 }, { id: 'p3c', name: 'เบ3C', total: 28 },
ย ย ย ย ย ย ย ย { id: 'p3d', name: 'เบ3D', total: 26 }, { id: 'p3e', name: 'เบ3E', total: 26 }, { id: 'p3f', name: 'เบ3F', total: 28 }, { id: 'p3g', name: 'เบ3G', total: 26 },
ย ย ย ย ย ย ย ย { id: 'p4a', name: 'เบ4A', total: 30 }, { id: 'p4b', name: 'เบ4B', total: 29 }, { id: 'p4c', name: 'เบ4C', total: 30 },
ย ย ย ย ย ย ย ย { id: 'p4d', name: 'เบ4D', total: 27 }, { id: 'p4e', name: 'เบ4E', total: 30 }, { id: 'p4f', name: 'เบ4F', total: 26 },
ย ย ย ย ย ย ย ย { id: 'p5a', name: 'เบ5A', total: 27 }, { id: 'p5b', name: 'เบ5B', total: 27 }, { id: 'p5c', name: 'เบ5C', total: 27 },
ย ย ย ย ย ย ย ย { id: 'p5d', name: 'เบ5D', total: 27 }, { id: 'p5e', name: 'เบ5E', total: 27 }, { id: 'p5f', name: 'เบ5F', total: 26 },
ย ย ย ย ย ย ]
ย ย ย ย };

ย ย ย ย const TEACHER_DEFAULTS = [
ย ย ย ย ย ย { id: 't_lao', name: 'Lao Teachers (เบเบนเบฅเบฒเบง)', total: 0, absent: 0, remarks: '' },
ย ย ย ย ย ย { id: 't_eng', name: 'English Teachers (เบเบนเบเบฒเบชเบฒเบญเบฑเบเบเบดเบ)', total: 0, absent: 0, remarks: '' }
ย ย ย ย ];

ย ย ย ย // --- INIT FIREBASE ---
ย ย ย ย async function initFirebase() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย if (!firebaseConfig.apiKey) {
ย ย ย ย ย ย ย ย ย ย console.warn("Firebase Config missing!");
ย ย ย ย ย ย ย ย ย ย document.getElementById('connectionStatus').innerHTML = '<span class="text-red-200">Config Missing</span>';
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย const app = initializeApp(firebaseConfig);
ย ย ย ย ย ย ย ย auth = getAuth(app);
ย ย ย ย ย ย ย ย db = getFirestore(app);

ย ย ย ย ย ย ย ย onAuthStateChanged(auth, (u) => {
ย ย ย ย ย ย ย ย ย ย user = u;
ย ย ย ย ย ย ย ย ย ย if (user) {
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('connectionStatus').innerHTML = `<div class="w-2 h-2 bg-green-400 rounded-full"></div> Connected`;
ย ย ย ย ย ย ย ย ย ย ย ย loadDataForView();
ย ย ย ย ย ย ย ย ย ย ย ย loadSettings();
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ยsignInAnonymously(auth).catch(e => console.error(e));
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Firebase Init Error:", e);
ย ย ย ย ย ย ย ย document.getElementById('connectionStatus').innerHTML = '<span class="text-red-200">Error</span>';
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- DB OPERATIONS ---
ย ย ย ย async function loadRecord(date) {
ย ย ย ย ย ย if (!db || !user) return null;
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', date);
ย ย ย ย ย ย ย ย const docSnap = await getDoc(docRef);
ย ย ย ย ย ย ย ย return docSnap.exists() ? docSnap.data() : null;
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Load Error:", e);
ย ย ย ย ย ย ย ย return null;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย async function saveRecord(date, dept, data, teachersOrSecStats) {
ย ย ย ย ย ย if (!db || !user) return;
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', date);
ย ย ย ย ย ย ย ย const docSnap = await getDoc(docRef);
ย ย ย ย ย ย ย ย let record = docSnap.exists() ? docSnap.data() : { date: date, departments: {}, teachers: [] };

ย ย ย ย ย ย ย ย if (dept === 'secondary') record.departments['secondary_stats'] = data;
ย ย ย ย ย ย ย ย else if (dept === 'kindergarten') record.departments['kindergarten_stats'] = data;
ย ย ย ย ย ย ย ย else {
ย ย ย ย ย ย ย ย ย ย record.departments[dept] = data;
ย ย ย ย ย ย ย ย ย ย record.teachers = teachersOrSecStats;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย await setDoc(docRef, record);
ย ย ย ย ย ย ย ย return true;
ย ย ย ย ย ย } catch (e) { console.error("Save Error:", e); throw e; }
ย ย ย ย }

ย ย ย ย // --- DATA LOADING LOGIC (Was Missing in original snippet) ---
ย ย ย ย async function loadDataForView() {
ย ย ย ย ย ย if (!db || !user) return;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Show loading state if needed, or just proceed
ย ย ย ย ย ย const data = await loadRecord(currentDate);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (currentDept === 'primary') {
ย ย ย ย ย ย ย ย // Load Primary Data
ย ย ย ย ย ย ย ย if (data && data.departments && data.departments['primary']) {
ย ย ย ย ย ย ย ย ย ย tableData = data.departments['primary'];
ย ย ย ย ย ย ย ย ย ย teacherData = data.teachers || JSON.parse(JSON.stringify(TEACHER_DEFAULTS));
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Initialize with defaults
ย ย ย ย ย ย ย ย ย ย tableData = JSON.parse(JSON.stringify(CLASS_STRUCTURE['primary']));
ย ย ย ย ย ย ย ย ย ย teacherData = JSON.parse(JSON.stringify(TEACHER_DEFAULTS));
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Sanitize Teacher Names (Fix old data with HTML tags)
ย ย ย ย ย ย ย ย if (teacherData && teacherData.length > 0) {
ย ย ย ย ย ย ย ย ย ย ยteacherData.forEach(t => {
ย ย ย ย ย ย ย ย ย ย ย ย ยif (t.name.includes('<br>')) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยt.name = t.name.replace(/<[^>]*>/g, ' ').replace('Lao Teachers', 'Lao Teachers (เบเบนเบฅเบฒเบง)').replace('English Teachers', 'English Teachers (เบเบนเบเบฒเบชเบฒเบญเบฑเบเบเบดเบ)').trim();
ย ย ย ย ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย ย ย ย ย ย});
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย renderTable();
ย ย ย ย ย ย } else if (currentDept === 'secondary') {
ย ย ย ย ย ย ย ย // Load Secondary Data
ย ย ย ย ย ย ย ย if (data && data.departments && data.departments['secondary_stats']) {
ย ย ย ย ย ย ย ย ย ย const stats = data.departments['secondary_stats'];
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_stu_total').value = stats.stuTotal || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_stu_absent').value = stats.stuAbsent || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_tea_total').value = stats.teaTotal || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_tea_absent').value = stats.teaAbsent || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_remarks').value = stats.remarks || '';
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Clear inputs
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_stu_total').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_stu_absent').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_tea_total').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_tea_absent').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('sec_remarks').value = '';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย updateSecondaryCalc();
ย ย ย ย ย ย } else if (currentDept === 'kindergarten') {
ย ย ย ย ย ย ย ย // Load Kindergarten Data
ย ย ย ย ย ย ย ย if (data && data.departments && data.departments['kindergarten_stats']) {
ย ย ย ย ย ย ย ย ย ย const stats = data.departments['kindergarten_stats'];
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_stu_total').value = stats.stuTotal || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_stu_absent').value = stats.stuAbsent || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_tea_total').value = stats.teaTotal || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_tea_absent').value = stats.teaAbsent || 0;
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_remarks').value = stats.remarks || '';
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Clear inputs
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_stu_total').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_stu_absent').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_tea_total').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_tea_absent').value = '';
ย ย ย ย ย ย ย ย ย ย document.getElementById('kin_remarks').value = '';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย updateKindergartenCalc();
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- LOGO HANDLING (COMPRESSED) ---
ย ย ย ย window.handleLogoUpload = function(input) {
ย ย ย ย ย ย if (input.files && input.files[0]) {
ย ย ย ย ย ย ย ย const file = input.files[0];
ย ย ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย ย ย reader.onload = function(e) {
ย ย ย ย ย ย ย ย ย ย const img = new Image();
ย ย ย ย ย ย ย ย ย ย img.src = e.target.result;
ย ย ย ย ย ย ย ย ย ย img.onload = async function() {
ย ย ย ย ย ย ย ย ย ย ย ย // Maximize quality within Firestore 1MB limit
ย ย ย ย ย ย ย ย ย ย ย ย const canvas = document.createElement('canvas');
ย ย ย ย ย ย ย ย ย ย ย ย // BUMPED TO 1024 to allow "No Limit" feeling while respecting strict DB limits
ย ย ย ย ย ย ย ย ย ย ย ย const MAX_WIDTH = 1024;ย
ย ย ย ย ย ย ย ย ย ย ย ย const MAX_HEIGHT = 1024;
ย ย ย ย ย ย ย ย ย ย ย ย let width = img.width;
ย ย ย ย ย ย ย ย ย ย ย ย let height = img.height;

ย ย ย ย ย ย ย ย ย ย ย ย if (width > height) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย canvas.width = width;
ย ย ย ย ย ย ย ย ย ย ย ย canvas.height = height;
ย ย ย ย ย ย ย ย ย ย ย ย const ctx = canvas.getContext('2d');
ย ย ย ย ย ย ย ย ย ย ย ย ctx.drawImage(img, 0, 0, width, height);
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย const base64 = canvas.toDataURL('image/png', 0.85); // High quality
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย // UI Update
ย ย ย ย ย ย ย ย ย ย ย ย updateLogoUI(base64);
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย // Save to DB
ย ย ย ย ย ย ย ย ย ย ย ย if(db && user) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย await setDoc(docRef, { logoUrl: base64 }, { merge: true });
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย showToast("Logo Saved & Updated!");
ย ย ย ย ย ย ย ย ย ย ย ย ย ย } catch(err) { console.error(err); showToast("Error saving logo (File too large for DB)"); }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย reader.readAsDataURL(file);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย async function loadSettings() {
ย ย ย ย ย ย if (!db || !user) return;
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
ย ย ย ย ย ย ย ย const docSnap = await getDoc(docRef);
ย ย ย ย ย ย ย ย if (docSnap.exists() && docSnap.data().logoUrl) {
ย ย ย ย ย ย ย ย ย ย updateLogoUI(docSnap.data().logoUrl);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (e) { console.error("Settings Load Error", e); }
ย ย ย ย }

ย ย ย ย function updateLogoUI(url) {
ย ย ย ย ย ย // Navbar
ย ย ย ย ย ย document.getElementById('appLogoDisplay').src = url;
ย ย ย ย ย ย document.getElementById('appLogoDisplay').classList.remove('hidden');
ย ย ย ย ย ย document.getElementById('defaultLogoText').classList.add('hidden');
ย ย ย ย ย ยย
ย ย ย ย ย ย // Report (Hidden by default, used in Print/Image)
ย ย ย ย ย ย // document.getElementById('reportLogo').src = url;
ย ย ย ย ย ย // document.getElementById('reportLogo').classList.remove('hidden');
ย ย ย ย ย ยย
ย ย ย ย ย ย // Favicon & Apple Icon
ย ย ย ย ย ย document.getElementById('favicon').href = url;
ย ย ย ย ย ย document.getElementById('appleTouchIcon').href = url;
ย ย ย ย }

ย ย ย ย // --- APP LOGIC ---
ย ย ย ย window.addEventListener('DOMContentLoaded', () => {
ย ย ย ย ย ย const yearSpan = document.getElementById('copyrightYear');
ย ย ย ย ย ย const schoolYearSpan = document.getElementById('schoolYear');
ย ย ย ย ย ย const currentYear = new Date().getFullYear();
ย ย ย ย ย ย yearSpan.textContent = currentYear;
ย ย ย ย ย ย const month = new Date().getMonth();
ย ย ย ย ย ย const sy = month >= 7 ? `${currentYear}-${currentYear+1}` : `${currentYear-1}-${currentYear}`;
ย ย ย ย ย ย schoolYearSpan.textContent = sy;

ย ย ย ย ย ย const dateSelector = document.getElementById('dateSelector');
ย ย ย ย ย ย let d = new Date();
ย ย ย ย ย ย if (d.getDay() === 0) d.setDate(d.getDate() + 1);
ย ย ย ย ย ย if (d.getDay() === 6) d.setDate(d.getDate() + 2);
ย ย ย ย ย ย currentDate = d.toISOString().split('T')[0];
ย ย ย ย ย ย dateSelector.value = currentDate;
ย ย ย ย ย ย document.getElementById('displayDate').textContent = formatDate(currentDate);

ย ย ย ย ย ย dateSelector.addEventListener('input', (e) => {
ย ย ย ย ย ย ย ย const val = e.target.value;
ย ย ย ย ย ย ย ย if(!val) return;
ย ย ย ย ย ย ย ย const day = new Date(val).getDay();
ย ย ย ย ย ย ย ย if (day === 0 || day === 6) { alert("Please select a weekday (Monday - Friday)."); e.target.value = currentDate; return; }
ย ย ย ย ย ย ย ย currentDate = val;
ย ย ย ย ย ย ย ย document.getElementById('displayDate').textContent = formatDate(currentDate);
ย ย ย ย ย ย ย ย loadDataForView();
ย ย ย ย ย ย });

ย ย ย ย ย ย initFirebase();
ย ย ย ย });

ย ย ย ย // --- AUTO SAVE ---
ย ย ย ย window.autoSave = function() {
ย ย ย ย ย ย // Update UI Calcs first (Instant feedback)
ย ย ย ย ย ย if(currentDept === 'secondary') window.updateSecondaryCalc();
ย ย ย ย ย ย else if(currentDept === 'kindergarten') window.updateKindergartenCalc();
ย ย ย ย ย ย else renderTable(); // If primary inputs had oninput=autoSave

ย ย ย ย ย ย // Debounce Save
ย ย ย ย ย ย clearTimeout(saveTimeout);
ย ย ย ย ย ย saveTimeout = setTimeout(async () => {
ย ย ย ย ย ย ย ย await window.saveCurrentData(false); // False = silent/auto mode
ย ย ย ย ย ย }, 1000);
ย ย ย ย }

ย ย ย ย window.saveCurrentData = async function(isManual = true) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย if (currentDept === 'primary') {
ย ย ย ย ย ย ย ย ย ย await saveRecord(currentDate, 'primary', tableData, teacherData);
ย ย ย ย ย ย ย ย } else if (currentDept === 'secondary') {
ย ย ย ย ย ย ย ย ย ย await saveRecord(currentDate, 'secondary', secondaryStats, null);
ย ย ย ย ย ย ย ย } else if (currentDept === 'kindergarten') {
ย ย ย ย ย ย ย ย ย ย await saveRecord(currentDate, 'kindergarten', kindergartenStats, null);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย showToast(isManual ? "Data saved successfully!" : "Changes saved");
ย ย ย ย ย ย } catch (e) { console.error(e); if(isManual) showToast("Error saving data."); }
ย ย ย ย }

ย ย ย ย window.updateRow = function(type, index, field, value) {
ย ย ย ย ย ย const arr = type === 'student' ? tableData : teacherData;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (field === 'remarks' || field === 'name') {
ย ย ย ย ย ย ย ย arr[index][field] = value;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย arr[index][field] = parseInt(value) || 0;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย renderTable();
ย ย ย ย ย ย // Trigger auto-save for primary inputs
ย ย ย ย ย ย window.autoSave();ย
ย ย ย ย }

ย ย ย ย window.switchTab = function(dept) {
ย ย ย ย ย ย currentDept = dept;
ย ย ย ย ย ย const tabs = ['kindergarten', 'primary', 'secondary'];
ย ย ย ย ย ย tabs.forEach(t => {
ย ย ย ย ย ย ย ย const btn = document.getElementById(`tab-${t}`);
ย ย ย ย ย ย ย ย if (!btn) return;
ย ย ย ย ย ย ย ย if (t === dept) {
ย ย ย ย ย ย ย ย ย ย btn.className = "flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all bg-white shadow text-emerald-700 lao-text";
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย btn.className = "flex-1 py-2 px-2 rounded-md text-xs sm:text-sm font-medium transition-all hover:bg-gray-200 text-gray-700 lao-text";
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย document.getElementById('kindergartenView').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('primaryView').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('secondaryView').classList.add('hidden');
ย ย ย ย ย ย document.getElementById(`${dept}View`).classList.remove('hidden');

ย ย ย ย ย ย const primActions = document.getElementById('primaryActions');
ย ย ย ย ย ย if (dept === 'primary') {
ย ย ย ย ย ย ย ย primActions.classList.remove('hidden');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย primActions.classList.add('hidden');
ย ย ย ย ย ย }
ย ย ย ย ย ย loadDataForView();
ย ย ย ย }

ย ย ย ย window.updateKindergartenCalc = function() {
ย ย ย ย ย ย const stuTotal = parseInt(document.getElementById('kin_stu_total').value) || 0;
ย ย ย ย ย ย const stuAbsent = parseInt(document.getElementById('kin_stu_absent').value) || 0;
ย ย ย ย ย ย const teaTotal = parseInt(document.getElementById('kin_tea_total').value) || 0;
ย ย ย ย ย ย const teaAbsent = parseInt(document.getElementById('kin_tea_absent').value) || 0;
ย ย ย ย ย ย const remarks = document.getElementById('kin_remarks').value || '';

ย ย ย ย ย ย const stuPresent = Math.max(0, stuTotal - stuAbsent);
ย ย ย ย ย ย const teaPresent = Math.max(0, teaTotal - teaAbsent);
ย ย ย ย ย ย const grandTotal = stuPresent + teaPresent;

ย ย ย ย ย ย document.getElementById('kin_stu_present').value = stuPresent;
ย ย ย ย ย ย document.getElementById('kin_tea_present').value = teaPresent;

ย ย ย ย ย ย kindergartenStats = { stuTotal, stuAbsent, teaTotal, teaAbsent, remarks };

ย ย ย ย ย ย const dateStr = formatDateShort(currentDate);
ย ย ย ย ย ย const percent = stuTotal > 0 ? ((stuPresent / stuTotal) * 100).toFixed(1) + '%' : '0%';

ย ย ย ย ย ย const reportHTML = `Neerada School Attendance / เปเบฎเบเบฎเบฝเบ เบเบตเบฃเบฐเบเบฒ
๐ Date / เบงเบฑเบเบเบต: ${dateStr} (เบญเบฐเบเบธเบเบฒเบ)
------------------
๐ Students / เบเบฑเบเบฎเบฝเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${stuTotal}
โ Present / เบกเบฒ: ${stuPresent}
โ Absent / เบเบฒเบ: ${stuAbsent}
๐ Rate / เปเบเบตเปเบเบฑเบ: ${percent}

๐ฉโ๐ซ Teachers / เบเบนเบญเบฒเบเบฒเบ & เบเบนเบฎเบฑเบเปเบเบตเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${teaTotal}
โ Present / เบกเบฒ: ${teaPresent}
โ Absent / เบเบฒเบ: ${teaAbsent}
๐ เปเบฒเบเปเบซเบ / Remarks: ${remarks || '-'}
๐ เบฅเบงเบกเบเบน เปเบฅเบฐ เบเบฑเบเบฎเบฝเบเบกเบฒเบเบปเบงเบเบดเบ: ${grandTotal}`;
ย ย ย ย ย ย document.getElementById('kindergartenReportText').innerText = reportHTML;
ย ย ย ย }

ย ย ย ย window.updateSecondaryCalc = function() {
ย ย ย ย ย ย const stuTotal = parseInt(document.getElementById('sec_stu_total').value) || 0;
ย ย ย ย ย ย const stuAbsent = parseInt(document.getElementById('sec_stu_absent').value) || 0;
ย ย ย ย ย ย const teaTotal = parseInt(document.getElementById('sec_tea_total').value) || 0;
ย ย ย ย ย ย const teaAbsent = parseInt(document.getElementById('sec_tea_absent').value) || 0;
ย ย ย ย ย ย const remarks = document.getElementById('sec_remarks').value || '';

ย ย ย ย ย ย const stuPresent = Math.max(0, stuTotal - stuAbsent);
ย ย ย ย ย ย const teaPresent = Math.max(0, teaTotal - teaAbsent);
ย ย ย ย ย ย const grandTotal = stuPresent + teaPresent;

ย ย ย ย ย ย document.getElementById('sec_stu_present').value = stuPresent;
ย ย ย ย ย ย document.getElementById('sec_tea_present').value = teaPresent;

ย ย ย ย ย ย secondaryStats = { stuTotal, stuAbsent, teaTotal, teaAbsent, remarks };

ย ย ย ย ย ย const dateStr = formatDateShort(currentDate);
ย ย ย ย ย ย const percent = stuTotal > 0 ? ((stuPresent / stuTotal) * 100).toFixed(1) + '%' : '0%';

ย ย ย ย ย ย // UPDATED PREVIEW TEXT FORMAT - SECONDARY
ย ย ย ย ย ย const reportHTML = `Neerada School Attendance / เปเบฎเบเบฎเบฝเบ เบเบตเบฃเบฐเบเบฒ
๐ Date / เบงเบฑเบเบเบต: ${dateStr} (เบกเบฑเบเบเบฐเบเบปเบก)
------------------
๐ Students / เบเบฑเบเบฎเบฝเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${stuTotal}
โ Present / เบกเบฒ: ${stuPresent}
โ Absent / เบเบฒเบ: ${stuAbsent}
๐ Rate / เปเบเบตเปเบเบฑเบ: ${percent}

๐ฉโ๐ซ Teachers / เบเบนเบญเบฒเบเบฒเบ & เบเบนเบฎเบฑเบเปเบเบตเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${teaTotal}
โ Present / เบกเบฒ: ${teaPresent}
โ Absent / เบเบฒเบ: ${teaAbsent}
๐ เปเบฒเบเปเบซเบ / Remarks: ${remarks || '-'}
๐ เบฅเบงเบกเบเบน เปเบฅเบฐ เบเบฑเบเบฎเบฝเบเบกเบฒเบเบปเบงเบเบดเบ: ${grandTotal}`;
ย ย ย ย ย ย document.getElementById('secondaryReportText').innerText = reportHTML;
ย ย ย ย }

ย ย ย ย // Helper: Format Date
ย ย ย ย function formatDate(dateStr) {
ย ย ย ย ย ย const d = new Date(dateStr);
ย ย ย ย ย ย const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
ย ย ย ย ย ย return `${days[d.getDay()]} ${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
ย ย ย ย }
ย ย ย ย function formatDateShort(dateStr) {
ย ย ย ย ย ย const d = new Date(dateStr);
ย ย ย ย ย ย return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
ย ย ย ย }

ย ย ย ย // Helper: Render Table
ย ย ย ย function renderTable() {
ย ย ย ย ย ย const tbody = document.getElementById('attendanceTableBody');
ย ย ย ย ย ย tbody.innerHTML = '';
ย ย ย ย ย ย liveStats.students = { total: 0, present: 0, absent: 0 };
ย ย ย ย ย ย liveStats.teachers = { total: 0, present: 0, absent: 0 }; // Init Teachers

ย ย ย ย ย ย tableData.forEach((row, index) => {
ย ย ย ย ย ย ย ย const total = parseInt(row.total) || 0;
ย ย ย ย ย ย ย ย const absent = parseInt(row.absent) || 0;
ย ย ย ย ย ย ย ย const present = Math.max(0, total - absent);
ย ย ย ย ย ย ย ย liveStats.students.total += total; liveStats.students.present += present; liveStats.students.absent += absent;

ย ย ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย ย ย tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
ย ย ย ย ย ย ย ย tr.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-gray-200 text-center text-gray-500 text-xs">${index + 1}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" class="w-full h-full p-2 text-center font-bold text-xs bg-transparent focus:bg-emerald-50 outline-none"ย
ย ย ย ย ย ย ย ย ย ย ย ย value="${row.name}" onchange="updateRow('student', ${index}, 'name', this.value)">
ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-emerald-50 outline-none text-xs" value="${row.total}" onchange="updateRow('student', ${index}, 'total', this.value)"></td>
ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200"><input type="number" readonly class="w-full h-full p-2 text-center outline-none text-xs" value="${present}"></td>
ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200 bg-red-50/30"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-red-50 text-red-700 font-bold outline-none text-xs" value="${row.absent}" onchange="updateRow('student', ${index}, 'absent', this.value)"></td>
ย ย ย ย ย ย ย ย ย ย <td class="p-0"><input type="text" class="w-full h-full p-2 text-left bg-transparent focus:bg-yellow-50 outline-none lao-text text-[10px]" value="${row.remarks || ''}" onchange="updateRow('student', ${index}, 'remarks', this.value)"></td>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย tbody.appendChild(tr);
ย ย ย ย ย ย });

ย ย ย ย ย ย // Teachers
ย ย ย ย ย ย const teacherBody = document.getElementById('teacherTableBody');
ย ย ย ย ย ย teacherBody.innerHTML = '';
ย ย ย ย ย ย teacherData.forEach((row, index) => {
ย ย ย ย ย ย ย ย const total = parseInt(row.total) || 0;
ย ย ย ย ย ย ย ย const absent = parseInt(row.absent) || 0;
ย ย ย ย ย ย ย ย const present = Math.max(0, total - absent);
ย ย ย ย ย ย ย ย liveStats.teachers.total += total; liveStats.teachers.present += present; liveStats.teachers.absent += absent; // Track teachers

ย ย ย ย ย ย ย ย // Note: Width of first cell explicitly matches student table for alignment
ย ย ย ย ย ย ย ย teacherBody.innerHTML += `
ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-gray-200 text-center text-gray-400 text-xs">-</td>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" class="w-full h-full p-2 text-center font-bold text-gray-700 text-xs bg-transparent focus:bg-emerald-50 outline-none"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย value="${row.name}" onchange="updateRow('teacher', ${index}, 'name', this.value)">
ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-emerald-50 outline-none text-xs" value="${row.total}" onchange="updateRow('teacher', ${index}, 'total', this.value)"></td>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200"><input type="number" readonly class="w-full h-full p-2 text-center outline-none text-xs" value="${present}"></td>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-0 border-r border-gray-200 bg-red-50/30"><input type="number" min="0" class="w-full h-full p-2 text-center bg-transparent focus:bg-red-50 text-red-700 font-bold outline-none text-xs" value="${row.absent}" onchange="updateRow('teacher', ${index}, 'absent', this.value)"></td>
ย ย ย ย ย ย ย ย ย ย ย ย <td class="p-0"><input type="text" class="w-full h-full p-2 text-left bg-transparent focus:bg-yellow-50 outline-none lao-text text-[10px]" value="${row.remarks || ''}" onchange="updateRow('teacher', ${index}, 'remarks', this.value)"></td>
ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย });

ย ย ย ย ย ย // Student Summary Row (Injected after students)
ย ย ย ย ย ย const percentStudents = liveStats.students.total > 0 ? ((liveStats.students.present / liveStats.students.total) * 100).toFixed(1) : 0;
ย ย ย ย ย ย document.getElementById('studentTotalBody').innerHTML = `
ย ย ย ย ย ย ย ย <tr class="bg-emerald-100 font-bold text-gray-900">
ย ย ย ย ย ย ย ย ย ย <td colspan="2" class="p-2 border-r border-emerald-200 text-right pr-2 lao-text text-xs">เบฅเบงเบกเบเบฑเบเบฎเบฝเบ (Total Students)</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-emerald-200 text-xs text-center">${liveStats.students.total}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-emerald-200 text-xs text-center">${liveStats.students.present}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-emerald-200 text-red-700 text-xs text-center">${liveStats.students.absent}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 text-left text-[10px] text-gray-600"><span class="font-bold">${percentStudents}%</span> Present</td>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย `;

ย ย ย ย ย ย // Teacher Summary Row (Injected after teachers)
ย ย ย ย ย ย const percentTeachers = liveStats.teachers.total > 0 ? ((liveStats.teachers.present / liveStats.teachers.total) * 100).toFixed(1) : 0;
ย ย ย ย ย ย document.getElementById('teacherTotalBody').innerHTML = `
ย ย ย ย ย ย ย ย <tr class="bg-blue-100 font-bold text-gray-900">
ย ย ย ย ย ย ย ย ย ย <td colspan="2" class="p-2 border-r border-blue-200 text-right pr-2 lao-text text-xs">เบฅเบงเบกเบเบน (Total Teachers)</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-blue-200 text-xs text-center">${liveStats.teachers.total}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-blue-200 text-xs text-center">${liveStats.teachers.present}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 border-r border-blue-200 text-red-700 text-xs text-center">${liveStats.teachers.absent}</td>
ย ย ย ย ย ย ย ย ย ย <td class="p-2 text-left text-[10px] text-gray-600"><span class="font-bold">${percentTeachers}%</span> Present</td>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย `;
ย ย ย ย }

ย ย ย ย window.copyKindergartenText = function() {
ย ย ย ย ย ย const text = document.getElementById('kindergartenReportText').innerText;
ย ย ย ย ย ย copyToClipboard(text);
ย ย ย ย }

ย ย ย ย window.copySecondaryText = function() {
ย ย ย ย ย ย const text = document.getElementById('secondaryReportText').innerText;
ย ย ย ย ย ย copyToClipboard(text);
ย ย ย ย }

ย ย ย ย window.copyTextSummary = function() {
ย ย ย ย ย ย const dateStr = formatDateShort(currentDate);
ย ย ย ย ย ย const percent = liveStats.students.total > 0 ? ((liveStats.students.present / liveStats.students.total) * 100).toFixed(1) + '%' : '0%';
ย ย ย ย ย ยย
ย ย ย ย ย ย // Gather Teacher Remarks
ย ย ย ย ย ย let teacherRemarks = [];
ย ย ย ย ย ย teacherData.forEach(t => {
ย ย ย ย ย ย ย ย if(t.remarks && t.remarks.trim() !== '') {
ย ย ย ย ย ย ย ย ย ย // Extract name from "Lao Teachers (เบเบนเบฅเบฒเบง)" to just "Lao Teachers" or "เบเบนเบฅเบฒเบง" if preferred, keeping simple for now
ย ย ย ย ย ย ย ย ย ย const shortName = t.name.replace(/<[^>]*>/g, '').split(' (')[0];ย
ย ย ย ย ย ย ย ย ย ย teacherRemarks.push(`${shortName}: ${t.remarks}`);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย ย ย const remarksStr = teacherRemarks.length > 0 ? teacherRemarks.join(', ') : '= เบกเบฒเบเบฑเบเปเบปเบ';

ย ย ย ย ย ย // UPDATED PRIMARY TEXT FORMAT
ย ย ย ย ย ย const text = `Neerada School Attendance / เปเบฎเบเบฎเบฝเบ เบเบตเบฃเบฐเบเบฒ
๐ Date / เบงเบฑเบเบเบต: ${dateStr} (เบเบฐเบเบปเบก)
------------------
๐ Students / เบเบฑเบเบฎเบฝเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${liveStats.students.total}
โ Present / เบกเบฒ: ${liveStats.students.present}
โ Absent / เบเบฒเบ: ${liveStats.students.absent}
๐ Rate / เปเบเบตเปเบเบฑเบ: ${percent}

๐ฉโ๐ซ Teachers / เบเบนเบญเบฒเบเบฒเบ:
๐ฅ Total / เบเบฑเบเปเบปเบ: ${liveStats.teachers.total}
โ Present / เบกเบฒ: ${liveStats.teachers.present}
โ Absent / เบเบฒเบ: ${liveStats.teachers.absent}
๐ เปเบฒเบเปเบซเบ / Remarks: ${remarksStr}`;
ย ย ย ย ย ย copyToClipboard(text);
ย ย ย ย }

ย ย ย ย async function copyToClipboard(text) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย await navigator.clipboard.writeText(text);
ย ย ย ย ย ย ย ย showToast("Copied to Clipboard!");
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย const textArea = document.createElement("textarea");
ย ย ย ย ย ย ย ย ย ย textArea.value = text;
ย ย ย ย ย ย ย ย ย ย textArea.style.position = "fixed";
ย ย ย ย ย ย ย ย ย ย textArea.style.left = "-9999px";
ย ย ย ย ย ย ย ย ย ย document.body.appendChild(textArea);
ย ย ย ย ย ย ย ย ย ย textArea.focus();
ย ย ย ย ย ย ย ย ย ย textArea.select();
ย ย ย ย ย ย ย ย ย ย document.execCommand('copy');
ย ย ย ย ย ย ย ย ย ย document.body.removeChild(textArea);
ย ย ย ย ย ย ย ย ย ย showToast("Copied to Clipboard!");
ย ย ย ย ย ย ย ย } catch (fallbackErr) {
ย ย ย ย ย ย ย ย ย ย console.error('Fallback copy failed', fallbackErr);
ย ย ย ย ย ย ย ย ย ย showToast("Error Copying");
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย window.captureImage = function() {
ย ย ย ย ย ย document.getElementById('loadingOverlay').classList.remove('hidden');
ย ย ย ย ย ย const element = document.getElementById('reportCard');
ย ย ย ย ย ยย
ย ย ย ย ย ย // 1. Create a "Ghost" Clone
ย ย ย ย ย ย const ghost = element.cloneNode(true);
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. ROBUST DATA CAPTURE: Replace Inputs with Text
ย ย ย ย ย ย // html2canvas often fails with inputs. We will replace every input in the ghost
ย ย ย ย ย ย // with a standard text element containing the value.
ย ย ย ย ย ย const originalInputs = element.querySelectorAll('input, textarea');
ย ย ย ย ย ย const ghostInputs = ghost.querySelectorAll('input, textarea');

ย ย ย ย ย ย ghostInputs.forEach((ghostInput, i) => {
ย ย ย ย ย ย ย ย const originalInput = originalInputs[i];
ย ย ย ย ย ย ย ย const val = originalInput.value || '';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย ย ย div.textContent = val;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Copy classes
ย ย ย ย ย ย ย ย div.className = ghostInput.className;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Fix styles for text rendering vs input rendering
ย ย ย ย ย ย ย ย div.style.display = 'flex';
ย ย ย ย ย ย ย ย div.style.alignItems = 'center'; // Vertical align
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Horizontal align based on class
ย ย ย ย ย ย ย ย if (ghostInput.classList.contains('text-center')) {
ย ย ย ย ย ย ย ย ย ย div.style.justifyContent = 'center';
ย ย ย ย ย ย ย ย ย ย div.style.textAlign = 'center';
ย ย ย ย ย ย ย ย } else if (ghostInput.classList.contains('text-right')) {
ย ย ย ย ย ย ย ย ย ย div.style.justifyContent = 'flex-end';
ย ย ย ย ย ย ย ย ย ย div.style.textAlign = 'right';
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย div.style.justifyContent = 'flex-start';
ย ย ย ย ย ย ย ย ย ย div.style.textAlign = 'left';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Remove background/border styles if they look weird on div,ย
ย ย ย ย ย ย ย ย // but usually keeping them is fine if they are bg-transparent.
ย ย ย ย ย ย ย ย // The inputs in the code are bg-transparent usually.
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Replace in DOM
ย ย ย ย ย ย ย ย if(ghostInput.parentNode) {
ย ย ย ย ย ย ย ย ย ย ghostInput.parentNode.replaceChild(div, ghostInput);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย // 3. Style Ghost for PERFECT Capture
ย ย ย ย ย ย ghost.style.position = 'absolute';
ย ย ย ย ย ย ghost.style.left = '0';ย
ย ย ย ย ย ย ghost.style.top = '0';
ย ย ย ย ย ย ghost.style.width = '800px';ย
ย ย ย ย ย ย ghost.style.minWidth = '800px';
ย ย ย ย ย ย ghost.style.height = 'auto';ย
ย ย ย ย ย ย ghost.style.zIndex = '-9999'; // Hide behind app
ย ย ย ย ย ย ghost.style.background = 'white';
ย ย ย ย ย ย ghost.style.overflow = 'visible'; // Ensure no scrollbars inside
ย ย ย ย ย ย ghost.style.transform = 'none';

ย ย ย ย ย ย // Ensure table container inside ghost expands fully
ย ย ย ย ย ย const ghostTableContainer = ghost.querySelector('.overflow-x-auto');
ย ย ย ย ย ย if(ghostTableContainer) {
ย ย ย ย ย ย ย ย ghostTableContainer.style.overflow = 'visible';
ย ย ย ย ย ย ย ย ghostTableContainer.style.height = 'auto';
ย ย ย ย ย ย ย ย ghostTableContainer.style.width = '100%';
ย ย ย ย ย ย }

ย ย ย ย ย ย // Re-add Logo to Header
ย ย ย ย ย ย const logoSrc = document.getElementById('appLogoDisplay').src;
ย ย ย ย ย ย if(logoSrc && !logoSrc.includes('window.location.href')) {
ย ย ย ย ย ย ย ย const headerDiv = ghost.querySelector('.bg-gray-50');
ย ย ย ย ย ย ย ย if(headerDiv) {
ย ย ย ย ย ย ย ย ย ย const img = document.createElement('img');
ย ย ย ย ย ย ย ย ย ย img.src = logoSrc;
ย ย ย ย ย ย ย ย ย ย img.className = "absolute left-6 top-6 h-16 w-16 object-contain";
ย ย ย ย ย ย ย ย ย ย headerDiv.appendChild(img);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }

ย ย ย ย ย ย document.body.appendChild(ghost);

ย ย ย ย ย ย // 4. Wait slightly for DOM to settle
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย const height = ghost.scrollHeight + 50; // Calculate full height
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const options = {
ย ย ย ย ย ย ย ย ย ย scale: 2, // High resolution
ย ย ย ย ย ย ย ย ย ย backgroundColor: '#ffffff',ย
ย ย ย ย ย ย ย ย ย ย useCORS: true,
ย ย ย ย ย ย ย ย ย ย // FORCE dimensions to match the Ghost, ignoring the phone screen size
ย ย ย ย ย ย ย ย ย ย width: 800,ย
ย ย ย ย ย ย ย ย ย ย windowWidth: 800,ย
ย ย ย ย ย ย ย ย ย ย height: height,ย
ย ย ย ย ย ย ย ย ย ย windowHeight: height,
ย ย ย ย ย ย ย ย ย ย scrollY: 0,ย
ย ย ย ย ย ย ย ย ย ย x: 0,
ย ย ย ย ย ย ย ย ย ย y: 0
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย html2canvas(ghost, options).then(canvas => {
ย ย ย ย ย ย ย ย ย ย document.body.removeChild(ghost); // Clean up
ย ย ย ย ย ย ย ย ย ย canvas.toBlob(async blob => {
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('loadingOverlay').classList.add('hidden');
ย ย ย ย ย ย ย ย ย ย ย ย if (!blob) { showToast("Error generating image"); return; }
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย const file = new File([blob], `attendance-${currentDate}.png`, { type: 'image/png' });
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย // Try Native Share (Mobile)
ย ย ย ย ย ย ย ย ย ย ย ย if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย try {ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย await navigator.share({ files: [file] });ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย showToast("Shared successfully!");ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // User cancelled or failed -> Fallback to download
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const link = document.createElement('a');ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.download = `attendance-${currentDate}.png`;ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.href = canvas.toDataURL();ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.click();ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Desktop Fallback
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const link = document.createElement('a');ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.download = `attendance-${currentDate}.png`;ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.href = canvas.toDataURL();ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย link.click();ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย showToast("Image downloaded!");
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }, 'image/png');
ย ย ย ย ย ย ย ย }).catch(err => {
ย ย ย ย ย ย ย ย ย ย console.error(err);
ย ย ย ย ย ย ย ย ย ย document.body.removeChild(ghost);
ย ย ย ย ย ย ย ย ย ย document.getElementById('loadingOverlay').classList.add('hidden');
ย ย ย ย ย ย ย ย ย ย showToast("Error capturing image");
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }, 500);
ย ย ย ย }

ย ย ย ย function showToast(msg) {
ย ย ย ย ย ย const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('translate-y-20', 'opacity-0');
ย ย ย ย ย ย setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
ย ย ย ย }
ย ย </script>
</body>
</html>
